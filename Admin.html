<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة الإدارة – Emperor Hills Alpha</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{ font-family:'Cairo',system-ui; background:#0f172a0a; }
    .card{ border-radius:16px; box-shadow:0 8px 24px #00000012 }
    .btn-pill{ border-radius:999px }
  </style>
</head>
<body>
  <nav class="navbar bg-white border-bottom shadow-sm">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <span class="fw-bold">لوحة الإدارة</span>
        <select id="building" class="form-select form-select-sm" style="width:120px">
          <option value="C2">C2</option><option value="C4">C4</option><option value="C6">C6</option>
        </select>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm btn-pill" href="users.html">إدارة المستخدمين</a>
        <button id="logout" class="btn btn-outline-secondary btn-sm btn-pill">خروج</button>
      </div>
    </div>
  </nav>

  <main class="container py-3">
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3"><div class="card p-3"><div class="text-muted small">وحدات مفحوصة</div><div id="kInspected" class="fw-bold fs-4">0</div></div></div>
      <div class="col-6 col-md-3"><div class="card p-3"><div class="text-muted small">وحدات مكتملة</div><div id="kDone" class="fw-bold fs-4">0</div></div></div>
      <div class="col-6 col-md-3"><div class="card p-3"><div class="text-muted small">آخر تحديث</div><div id="kUpdated" class="fw-bold fs-6">—</div></div></div>
    </div>

    <div class="card p-3">
      <h6>الوحدات</h6>
      <div id="list" class="row g-2"></div>
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAP5RViS9WdyEo8EaBflHyFag_T9_NKT7w",
      authDomain: "empiror-hills-alpha.firebaseapp.com",
      projectId: "empiror-hills-alpha",
      storageBucket: "empiror-hills-alpha.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const building = document.getElementById('building');
    const list = document.getElementById('list');
    const kInspected = document.getElementById('kInspected');
    const kDone = document.getElementById('kDone');
    const kUpdated = document.getElementById('kUpdated');

    function progressOf(u){
      const okSingle = (u.singlePts||[]).filter(Boolean).length;
      const okDouble = (u.doublePts||[]).filter(Boolean).length;
      const okTriple = (u.triplePts||[]).filter(Boolean).length;
      const okRem = (u.remotes||[]).filter(Boolean).length;
      const total = okSingle + okDouble + okTriple + okRem + (u.ctlScreen?1:0) + (u.lock103?1:0);
      const max = 5+1+9+4+1+1;
      return Math.round(100*total/max);
    }

    function card(u){
      const pct = progressOf(u);
      const div=document.createElement('div');
      div.className='col-12 col-md-6 col-lg-4';
      div.innerHTML=`<div class="card p-3 h-100">
        <div class="d-flex justify-content-between">
          <div class="fw-bold">${u.unitLabel}</div>
          <span class="badge ${pct===100?'text-bg-success':'text-bg-secondary'}">${pct}%</span>
        </div>
        <div class="small text-muted">${u.tech?.name||''}</div>
      </div>`;
      return div;
    }

    async function load(){
      list.innerHTML='';
      const b = building.value;
      let inspected=0, done=0; let latest=0;
      const units=[];
      for(let f=1; f<=16; f++){
        for(const u of ['A','B','C','D']){
          const id = `${b}_${f}_${u}`;
          const snap = await db.collection('unitInspections').doc(id).get();
          if(snap.exists){
            const data = snap.data(); units.push(data);
            inspected++;
            if(progressOf(data)===100) done++;
            latest = Math.max(latest, (data.updatedAt?.toDate?.()||data.updatedAt||0));
          } else {
            units.push({ unitLabel:`${b}/${f}/${u}` });
          }
        }
      }
      units.forEach(u=> list.appendChild(card(u)));
      kInspected.textContent = inspected;
      kDone.textContent = done;
      kUpdated.textContent = latest? new Date(latest).toLocaleString('ar-IQ') : '—';
    }

    building.onchange=load;
    auth.onAuthStateChanged(u=>{ if(!u) location.href='index.html'; else load(); });
    logout.onclick=()=> auth.signOut().then(()=> location.href='index.html');
  </script>
</body>
</html>
