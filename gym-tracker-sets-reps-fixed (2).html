<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† + ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨</title>
<style>
  :root{
    --bg:#0b0f14; --card:#10161d; --muted:#90a4ae; --text:#e9f1f7;
    --accent:#28a745; --danger:#e53935; --brand:#3ea6ff; --chip:#1a232c;
    --border:#1e2933; --warn:#ffb300;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(160deg,#0b0f14,#0f1720 30%,#0b0f14);
       color:var(--text);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .container{max-width:1100px;margin:40px auto;padding:0 18px}
  header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
  .title{font-size:clamp(20px,3.4vw,32px);font-weight:800;letter-spacing:.2px}
  .subtitle{font-size:14px;color:var(--muted)}
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
  .sticky{position:sticky;top:0;z-index:5}
  .weekbar{display:flex;align-items:center;gap:10px}
  .barwrap{flex:1;background:#091018;border:1px solid var(--border);border-radius:999px;height:12px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#22c55e,#3ea76f)}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{background:var(--chip);border:1px dashed #29414f;border-radius:999px;padding:6px 10px;font-size:12px;color:#c7d6de}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .tab{background:#0f1720;border:1px solid var(--border);color:#cfe7ff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .tab.active{background:#113347;border-color:#1b5c85;box-shadow:0 0 0 2px rgba(62,166,255,.18) inset;color:#e9f6ff}
  .search{flex:1;min-width:220px;display:flex;align-items:center;gap:8px;background:#0f1720;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
  .search input{all:unset;direction:rtl;flex:1}
  .datebox{display:flex;gap:8px;align-items:center}
  input[type="date"]{background:#0f1720;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px}
  button, .btn{background:#113347;border:1px solid #1b5c85;color:#cfe7ff;border-radius:10px;padding:8px 12px;cursor:pointer}
  button:hover,.btn:hover{filter:brightness(1.07)}
  .exercise{display:grid;grid-template-columns:1fr;gap:10px;border:1px solid var(--border);border-radius:14px;padding:12px;background:#0c1218}
  .ex-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .ex-title{font-weight:700}
  .ex-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ex-tools input[type="text"], .ex-tools input[type="number"], .ex-tools textarea{
    background:#091018;border:1px solid var(--border);color:#e9f1f7;border-radius:10px;padding:7px 9px
  }
  .ex-tools input[type="text"}{min-width:200px;max-width:420px}
  .ex-tools input[type="number"]{width:80px;text-align:center}
  .ex-tools textarea{width:100%;min-height:52px;resize:vertical}
  .donebox{display:flex;align-items:center;gap:6px}
  .donebox input{width:20px;height:20px}
  .yt{width:100%;aspect-ratio:16/9;border:none;border-radius:12px;overflow:hidden;background:#000}
  .muted{color:var(--muted)}
  .foot{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;align-items:center;margin-top:8px}
  .hidden{display:none}
  .tip{font-size:12px;color:#9ec2d4}
</style>
</head>
<body>
<div class="container">
  <div class="card sticky">
    <header>
      <div>
        <div class="title">Ø¯ÙØªØ± Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ + Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
        <div class="subtitle">ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ø§Ù…ÙŠØ¹ ÙˆØªÙƒØ±Ø§Ø±Ø§Øª Ù…Ù‚ØªØ±ÙØ­Ø© Ù„ÙƒÙ„ ØªÙ…Ø±ÙŠÙ† â€” Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø¥Ø°Ø§ ØªØ­Ø¨.</div>
      </div>
      <div class="row">
        <div class="datebox">
          <label class="muted">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</label>
          <input id="dateInput" type="date">
          <button id="todayBtn" title="Ø±Ø¬Ù‘Ø¹ Ù„Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…">Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
        <div class="search">
          <span class="muted">Ø¨Ø­Ø« ØªÙ…Ø±ÙŠÙ†â€¦</span>
          <input id="searchInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªÙ…Ø±ÙŠÙ†" />
        </div>
      </div>
    </header>

    <div id="weekHeader" class="card">
      <div class="weekbar">
        <strong>Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong>
        <div class="barwrap"><div id="bar" class="bar" style="width:0%"></div></div>
        <div id="barText" class="muted"></div>
      </div>
      <div class="chips" id="weekChips"></div>
      <div class="tip" style="margin-top:8px">
        Ù‚Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø©: Ø§Ù„Ø¸Ù‡Ø±/Ø§Ù„ØµØ¯Ø±/Ø§Ù„ÙƒØªØ§Ù 4Ã—10ØŒ Ø§Ù„Ø°Ø±Ø§Ø¹ÙŠÙ† 3Ã—12ØŒ Ø§Ù„Ø£Ø±Ø¬Ù„ 4Ã—12ØŒ Ø§Ù„Ù…Ø¹Ø¯Ø© 3Ã—15ØŒ Ø§Ù„Ø³Ù…Ø§Ù†Ø© 4Ã—15.
      </div>
    </div>

    <div class="tabs" id="tabs"></div>
    <div class="foot">
      <div class="row">
        <button id="exportBtn">ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        <label class="btn" for="importFile">Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
        <input id="importFile" class="hidden" type="file" accept="application/json" />
      </div>
      <div class="row">
        <button id="clearDayBtn" style="color:#ffbdbd">Ù…Ø³Ø­ Ø¥Ù†Ø¬Ø§Ø² Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</button>
        <button id="clearAllBtn" style="color:#ffbdbd">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>
  </div>

  <div id="list" class="card" style="margin-top:16px"></div>
</div>

<script>
/* -------------------- Ø§Ù„Ø®Ø·Ø© -------------------- */
const PLAN = {
 "Ø§Ù„ÙŠÙˆÙ… Ù¡ (Ø¸Ù‡Ø±/Ø¨Ø§ÙŠØ³Ø¨ + ÙƒÙˆØ±)": [
  "Chest-supported T-bar row",
  "Wide grip assisted pull-ups / Lat pulldown",
  "Hammer Strength iso-lateral high row",
  "Dumbbell deadstop rows (Ø¹Ù„Ù‰ Incline bench)",
  "Straight-arm rope pulldown (standing tall)",
  "Dumbbell incline curls",
  "EZ-bar reverse curls (Ø¹Ù„Ù‰ preacher bench)",
  "Cable rope curls",
  "Hanging knee raises"
 ],
 "Ø§Ù„ÙŠÙˆÙ… Ù¢ (ØµØ¯Ø±/ØªØ±Ø§ÙŠØ³Ø¨ + Ø³Ù…Ø§Ù†Ø©)": [
  "Machine incline press",
  "Smith machine flat press",
  "Dumbbell floor press",
  "Pec deck fly",
  "EZ-bar skull crushers (flat bench)",
  "Rope pushdowns",
  "One-arm overhead cable extension",
  "Standing calf raise"
 ],
 "Ø§Ù„ÙŠÙˆÙ… Ù¤ (Ø£Ø±Ø¬Ù„/Ø£Ø±Ø¯Ø§Ù)": [
  "Lying leg curls",
  "Leg press",
  "Machine hack squat (ØªØ¬Ù†Ù‘Ø¨ Ø³ÙƒÙˆØ§Øª Ø­Ø±)",
  "Dumbbell Bulgarian split squat (Ø¨Ø¯ÙˆÙ† Ø­Ù…Ù„ Ø¹Ù…ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡Ø±)",
  "Leg extensions (Ù…Ø¹Ø§Ù‹)",
  "Glute bridges Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ (Ø¯Ù…Ø¨Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ¶)",
  "Seated calf raises"
 ],
 "Ø§Ù„ÙŠÙˆÙ… Ù¥ (ÙƒØªØ§Ù/Ø¨Ø§ÙŠØ³Ø¨/ØªØ±Ø§ÙŠØ³Ø¨)": [
  "Seated machine shoulder press",
  "Dumbbell side laterals",
  "Front cable raise (rope Ø£Ùˆ bar)",
  "Reverse pec deck fly",
  "Dumbbell shrugs (Ù…Ù…ÙƒÙ† Ø¬Ù„ÙˆØ³)",
  "Alternating dumbbell curls",
  "Cable preacher curls (single arm)",
  "Rope hammer curls",
  "Machine close-grip press / Smith machine",
  "Cable rope kickbacks"
 ]
};

/* --------- Ø±ÙˆØ§Ø¨Ø· + Ù…Ø¬Ø§Ù…ÙŠØ¹/ØªÙƒØ±Ø§Ø±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© --------- */
const DEFAULTS = {
  "Chest-supported T-bar row":         {sets:4, reps:10, url:"https://www.youtube.com/watch?v=IJjJfkPFiG0"},
  "Wide grip assisted pull-ups / Lat pulldown": {sets:4, reps:10, url:"https://www.youtube.com/watch?v=SALxEARiMkw"},
  "Hammer Strength iso-lateral high row": {sets:4, reps:10, url:"https://www.youtube.com/watch?v=beKbbq6NhWY"},
  "Dumbbell deadstop rows (Ø¹Ù„Ù‰ Incline bench)": {sets:4, reps:10, url:"https://www.youtube.com/watch?v=2LxN3_3atps"},
  "Straight-arm rope pulldown (standing tall)": {sets:4, reps:12, url:"https://www.youtube.com/watch?v=WDOV2PDpkiU"},
  "Dumbbell incline curls":            {sets:3, reps:12, url:"https://www.youtube.com/watch?v=soxrZlIl35U"},
  "EZ-bar reverse curls (Ø¹Ù„Ù‰ preacher bench)": {sets:3, reps:12, url:"https://www.youtube.com/watch?v=_ZHQMD_CdcQ"},
  "Cable rope curls":                  {sets:3, reps:12, url:"https://www.youtube.com/watch?v=Qt-NixlIVGM"},
  "Hanging knee raises":               {sets:3, reps:15, url:"https://www.youtube.com/watch?v=X-ACS9vpRyU"},
  "Machine incline press":             {sets:4, reps:10, url:"https://www.youtube.com/watch?v=YiC1-pNP4ig"},
  "Smith machine flat press":          {sets:4, reps:10, url:"https://www.youtube.com/watch?v=7FyJdsXeta8"},
  "Dumbbell floor press":              {sets:4, reps:10, url:"https://www.youtube.com/watch?v=AqYFvc9t_vU"},
  "Pec deck fly":                      {sets:4, reps:12, url:"https://www.youtube.com/watch?v=H4mVGHaK2f4"},
  "EZ-bar skull crushers (flat bench)": {sets:3, reps:12, url:"https://www.youtube.com/watch?v=d_KZxkY_0cM"},
  "Rope pushdowns":                    {sets:3, reps:12, url:"https://www.youtube.com/watch?v=2-LAMcpzODU"},
  "One-arm overhead cable extension":  {sets:3, reps:12, url:"https://www.youtube.com/watch?v=GzmlxvSFE7A"},
  "Standing calf raise":               {sets:4, reps:15, url:"https://www.youtube.com/watch?v=k67UjgvJdEk"},
  "Lying leg curls":                   {sets:4, reps:12, url:"https://www.youtube.com/watch?v=P7-RxTVe6O0"},
  "Leg press":                         {sets:4, reps:12, url:"https://www.youtube.com/watch?v=cDGOn-yfKJA"},
  "Machine hack squat (ØªØ¬Ù†Ù‘Ø¨ Ø³ÙƒÙˆØ§Øª Ø­Ø±)": {sets:4, reps:10, url:"https://www.youtube.com/watch?v=-lAnEGH2blE"},
  "Dumbbell Bulgarian split squat (Ø¨Ø¯ÙˆÙ† Ø­Ù…Ù„ Ø¹Ù…ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡Ø±)": {sets:4, reps:10, url:"https://www.youtube.com/watch?v=hiLF_pF3EJM"},
  "Leg extensions (Ù…Ø¹Ø§Ù‹)":             {sets:4, reps:12, url:"https://www.youtube.com/watch?v=swZQC689o9U"},
  "Glute bridges Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ (Ø¯Ù…Ø¨Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ¶)": {sets:4, reps:12, url:"https://www.youtube.com/watch?v=wPM8icPu6H8"},
  "Seated calf raises":                {sets:4, reps:15, url:"https://www.youtube.com/watch?v=6O5hh1rBtx8"},
  "Seated machine shoulder press":     {sets:4, reps:10, url:"https://www.youtube.com/watch?v=3R14MnZbcpw"},
  "Dumbbell side laterals":            {sets:4, reps:12, url:"https://www.youtube.com/watch?v=IdNOahFD450"},
  "Front cable raise (rope Ø£Ùˆ bar)":   {sets:4, reps:12, url:"https://www.youtube.com/watch?v=fqUgPii8Nm8"},
  "Reverse pec deck fly":              {sets:4, reps:12, url:"https://www.youtube.com/watch?v=dC7jhEk-29A"},
  "Dumbbell shrugs (Ù…Ù…ÙƒÙ† Ø¬Ù„ÙˆØ³)":      {sets:4, reps:12, url:"https://www.youtube.com/watch?v=xDt6qbKgLkY"},
  "Alternating dumbbell curls":        {sets:3, reps:12, url:"https://www.youtube.com/watch?v=in7PaeYlhrM"},
  "Cable preacher curls (single arm)": {sets:3, reps:12, url:"https://www.youtube.com/watch?v=ImGscaZatIQ"},
  "Rope hammer curls":                 {sets:3, reps:12, url:"https://www.youtube.com/watch?v=T8YbgwwGxaA"},
  "Machine close-grip press / Smith machine": {sets:3, reps:12, url:"https://www.youtube.com/watch?v=0TPkV7AXX8o"},
  "Cable rope kickbacks":              {sets:3, reps:12, url:"https://www.youtube.com/watch?v=VIH5vgxw_9c"}
};

/* -------------------- Ø«ÙˆØ§Ø¨Øª/Ù…Ø³Ø§Ø¹Ø¯Ø§Øª -------------------- */
const STORAGE_KEY = "gym_tracker_v4";
const PROG_KEY    = "gym_tracker_progress_v4";
const byId = (id)=>document.getElementById(id);
const S = (s)=>s.replace(/\s+/g,' ').trim();
const todayLocalISO = ()=> {
  const d = new Date();
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d.toISOString().slice(0,10);
};
const parseYT = (url)=>{
  if(!url) return null;
  try{
    const u = new URL(url);
    if(u.hostname.includes("youtu.be")) return u.pathname.slice(1);
    if(u.searchParams.get("v")) return u.searchParams.get("v");
    if(u.hostname.includes("youtube") && u.pathname.startsWith("/shorts/")) return u.pathname.split("/")[2];
    if(/^[\w-]{11}$/.test(url)) return url;
  }catch(e){}
  return null;
};
const weekInfo = (dateStr)=>{
  const d = new Date(dateStr + "T00:00:00");
  const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = (tmp.getUTCDay() + 6) % 7;
  tmp.setUTCDate(tmp.getUTCDate() - dayNum + 3);
  const firstThu = new Date(Date.UTC(tmp.getUTCFullYear(),0,4));
  const week = 1 + Math.round(((tmp - firstThu)/86400000 - 3 + ((firstThu.getUTCDay()+6)%7))/7);
  const year = tmp.getUTCFullYear();
  return {week, year, id:`${year}-W${String(week).padStart(2,'0')}`};
};
const ALL_DAYS = Object.keys(PLAN);

/* -------------------- Ø­Ø§Ù„Ø©/ØªØ®Ø²ÙŠÙ† -------------------- */
let db = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
let prog = JSON.parse(localStorage.getItem(PROG_KEY) || "{}");
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
function saveProg(){ localStorage.setItem(PROG_KEY, JSON.stringify(prog)); }

function ensureDefaults(){
  for(const [day, exs] of Object.entries(PLAN)){
    exs.forEach(ex=>{
      const key = `${day}|${ex}`;
      const def = DEFAULTS[ex] || {sets:"", reps:"", url:""};
      if(!db[key]) db[key] = {sets:def.sets||"", reps:def.reps||"", video:def.url||"", notes:""};
      else{
        if(!db[key].sets && def.sets) db[key].sets = def.sets;
        if(!db[key].reps && def.reps) db[key].reps = def.reps;
        if(!db[key].video && def.url) db[key].video = def.url;
        if(typeof db[key].notes !== "string") db[key].notes = "";
      }
    });
  }
  save();
}

/* -------------------- ÙˆØ§Ø¬Ù‡Ø© -------------------- */
const tabs = byId("tabs");
const list = byId("list");
const dateInput = byId("dateInput");
const todayBtn = byId("todayBtn");
const searchInput = byId("searchInput");
const exportBtn = byId("exportBtn");
const importFile = byId("importFile");
const clearAllBtn = byId("clearAllBtn");
const clearDayBtn = byId("clearDayBtn");

let currentDay = ALL_DAYS[0];

function renderTabs(){
  tabs.innerHTML = "";
  ALL_DAYS.forEach(d=>{
    const b = document.createElement("button");
    b.className = "tab" + (d===currentDay?" active":"");
    b.textContent = d;
    b.onclick = ()=>{ currentDay = d; renderTabs(); renderList(); };
    tabs.appendChild(b);
  });
}

function exerciseRow(day, ex){
  const key = `${day}|${ex}`;
  const state = db[key] || {sets:"", reps:"", video:"", notes:""};
  const date = dateInput.value;
  const done = !!(prog[date] && prog[date][day] && prog[date][day][key]);

  const exWrap = document.createElement("div");
  exWrap.className = "exercise";

  const head = document.createElement("div");
  head.className = "ex-head";
  const title = document.createElement("div");
  title.className = "ex-title";
  title.textContent = ex;
  const tools = document.createElement("div");
  tools.className = "ex-tools";

  const doneBox = document.createElement("label");
  doneBox.className = "donebox";
  const cbox = document.createElement("input");
  cbox.type = "checkbox"; cbox.checked = done;
  cbox.onchange = ()=>{
    if(!prog[date]) prog[date] = {};
    if(!prog[date][day]) prog[date][day] = {};
    if(cbox.checked) prog[date][day][key] = true;
    else delete prog[date][day][key];
    saveProg(); renderWeekHeader();
  };
  const doneTxt = document.createElement("span"); doneTxt.textContent = "Ù…ÙÙ†ÙØ¬Ù‘ÙØ²";
  doneBox.appendChild(cbox); doneBox.appendChild(doneTxt);

  const s = document.createElement("input"); s.type="number"; s.placeholder="Ù…Ø¬Ø§Ù…ÙŠØ¹"; s.value = state.sets||"";
  s.oninput = ()=>{ db[key].sets = s.value; save(); };
  const r = document.createElement("input"); r.type="number"; r.placeholder="ØªÙƒØ±Ø§Ø±Ø§Øª"; r.value = state.reps||"";
  r.oninput = ()=>{ db[key].reps = r.value; save(); };

  tools.appendChild(doneBox);
  tools.appendChild(s);
  tools.appendChild(r);

  head.appendChild(title);
  head.appendChild(tools);
  exWrap.appendChild(head);

  const vLine = document.createElement("div");
  vLine.className = "ex-tools";
  const v = document.createElement("input");
  v.type = "text"; v.placeholder = "Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨â€¦"; v.value = state.video||"";
  const open = document.createElement("a");
  open.className="btn"; open.target="_blank"; open.rel="noopener";
  open.href = v.value || `https://www.youtube.com/results?search_query=${encodeURIComponent(ex + " proper form")}`;
  open.textContent = v.value ? "ÙØªØ­ ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨" : "ğŸ” Ø¨Ø­Ø« ÙÙŠØ¯ÙŠÙˆ";
  v.oninput = ()=>{ db[key].video = v.value.trim(); save(); renderList(); };

  vLine.appendChild(v);
  vLine.appendChild(open);
  exWrap.appendChild(vLine);

  const id = parseYT(state.video);
  const frame = document.createElement("iframe");
  frame.className = "yt";
  frame.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
  frame.referrerPolicy = "strict-origin-when-cross-origin";
  frame.loading = "lazy";
  frame.src = id ? `https://www.youtube-nocookie.com/embed/${id}` : "about:blank";
  if(id){
    exWrap.appendChild(frame);
  }else{
    const tip = document.createElement("div");
    tip.className = "muted";
    tip.innerHTML = "Ù…Ø§ Ù…Ø¶Ø§Ù Ø±Ø§Ø¨Ø· Ø¨Ø¹Ø¯ â€” Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± <b>ğŸ” Ø¨Ø­Ø« ÙÙŠØ¯ÙŠÙˆ</b> Ø£Ùˆ Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· ÙˆØ³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø´ØºÙ‘Ù„.";
    exWrap.appendChild(tip);
  }

  const notes = document.createElement("textarea");
  notes.placeholder = "Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø£ÙˆØ²Ø§Ù† / Ø¥Ø­Ø³Ø§Ø³ Ø§Ù„Ø¹Ø¶Ù„Ø©â€¦";
  notes.value = state.notes||"";
  notes.oninput = ()=>{ db[key].notes = notes.value; save(); };
  exWrap.appendChild(notes);

  return exWrap;
}

function renderList(){
  const q = S(searchInput.value||"").toLowerCase();
  list.innerHTML = "";
  const exs = PLAN[currentDay]
     .filter(x=> !q || x.toLowerCase().includes(q));
  if(!exs.length){
    list.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</div>`;
    return;
  }
  exs.forEach(ex=> list.appendChild(exerciseRow(currentDay, ex)));
}

function sumWeek(weekId){
  let done=0, total=0;
  for(const [date, perDay] of Object.entries(prog)){
    if(weekInfo(date).id !== weekId) continue;
    for(const [day, obj] of Object.entries(perDay)){
      total += PLAN[day].length;
      done += Object.keys(obj||{}).length;
    }
  }
  return {done,total};
}

function allWeeksSorted(){
  const set = new Set(Object.keys(prog).map(d=>weekInfo(d).id));
  return Array.from(set).sort().reverse();
}

function renderWeekHeader(){
  const cur = weekInfo(dateInput.value);
  const {done,total} = sumWeek(cur.id);
  const pct = total? Math.round(done*100/total):0;
  byId("bar").style.width = pct+"%";
  byId("barText").textContent = `${done}/${total} (${pct}%) Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (${cur.id})`;

  const chips = byId("weekChips");
  chips.innerHTML = "";
  allWeeksSorted().forEach(id=>{
    const v = sumWeek(id);
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = `${id}: ${v.done}/${v.total}`;
    chips.appendChild(chip);
  });
}

function exportJSON(){
  const data = {
    plan: PLAN,
    entries: db,
    progress: prog,
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "gym-tracker-backup.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if(data.entries) db = data.entries;
      if(data.progress) prog = data.progress;
      save(); saveProg();
      renderList(); renderWeekHeader();
      alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    }catch(e){
      alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.");
    }
  };
  reader.readAsText(file);
}

function clearDay(){
  const d = dateInput.value;
  if(!prog[d]) return;
  if(confirm("Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø³Ø­ Ø¥Ù†Ø¬Ø§Ø² Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŸ")) {
    delete prog[d];
    saveProg();
    renderList(); renderWeekHeader();
  }
}
function clearAll(){
  if(confirm("Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")){
    db = {}; prog = {};
    save(); saveProg();
    ensureDefaults();
    renderList(); renderWeekHeader();
  }
}

/* -------------------- Ø£Ø­Ø¯Ø§Ø« -------------------- */
dateInput.onchange = ()=>{ renderList(); renderWeekHeader(); };
todayBtn.onclick = ()=>{ dateInput.value = todayLocalISO(); dateInput.onchange(); };
searchInput.oninput = ()=> renderList();
exportBtn.onclick = exportJSON;
importFile.onchange = (e)=> e.target.files[0] && importJSON(e.target.files[0]);
clearAllBtn.onclick = clearAll;
clearDayBtn.onclick = clearDay;

/* -------------------- Ø¥Ù‚Ù„Ø§Ø¹ (Ø«Ø§Ø¨Øª ÙˆÙ…Ø¨Ø³Ù‘Ø·) -------------------- */
(function init(){
  if(!Object.keys(db).length){ ensureDefaults(); }
  dateInput.value = todayLocalISO();
  renderTabs();      // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… window.currentDay Ø¥Ø·Ù„Ø§Ù‚Ø§Ù‹
  renderList();
  renderWeekHeader();
})();
</script>
</body>
</html>
