<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emperor Hills Alpha – تسجيل الدخول</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{ font-family:'Cairo',system-ui; background:#0f172a0a; }
    .card{ border-radius:16px; box-shadow:0 8px 24px #00000012 }
    .btn-pill{ border-radius:999px }
  </style>
</head>
<body>
  <nav class="navbar bg-white border-bottom shadow-sm">
    <div class="container-fluid">
      <span class="fw-bold">Emperor Hills Alpha</span>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row g-3">
      <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
          <h5>تسجيل الدخول</h5>
          <div class="mb-2"><input id="liEmail" type="email" class="form-control" placeholder="name@example.com" /></div>
          <div class="mb-2"><input id="liPassword" type="password" class="form-control" placeholder="كلمة المرور" /></div>
          <div class="d-flex gap-2">
            <button id="btnLogin" class="btn btn-primary btn-pill">دخول</button>
            <button id="btnRst" class="btn btn-light btn-pill">استرجاع كلمة المرور</button>
          </div>
          <div id="liMsg" class="small text-muted mt-2"></div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
          <h5>تسجيل حساب جديد</h5>
          <div class="mb-2"><input id="suEmail" type="email" class="form-control" placeholder="name@example.com" /></div>
          <div class="mb-2"><input id="suPassword" type="password" class="form-control" placeholder="كلمة المرور" /></div>
          <div class="mb-2"><input id="suName" class="form-control" placeholder="الاسم" /></div>
          <div class="mb-2">
            <label class="form-label">البنايات</label>
            <div class="d-flex gap-3">
              <div class="form-check"><input id="sC2" class="form-check-input" type="checkbox" value="C2"><label class="form-check-label" for="sC2">C2</label></div>
              <div class="form-check"><input id="sC4" class="form-check-input" type="checkbox" value="C4"><label class="form-check-label" for="sC4">C4</label></div>
              <div class="form-check"><input id="sC6" class="form-check-input" type="checkbox" value="C6"><label class="form-check-label" for="sC6">C6</label></div>
            </div>
          </div>
          <button id="btnSignup" class="btn btn-success btn-pill">إنشاء الحساب</button>
          <div id="suMsg" class="small text-muted mt-2"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAP5RViS9WdyEo8EaBflHyFag_T9_NKT7w",
      authDomain: "empiror-hills-alpha.firebaseapp.com",
      projectId: "empiror-hills-alpha",
      storageBucket: "empiror-hills-alpha.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    async function ensureUserDoc(u, opts={}) {
      const ref = db.collection('users').doc(u.uid);
      const snap = await ref.get();
      const base = {
        displayName: u.displayName || (opts.name||''),
        email: u.email,
        phone: '',
        role: 'tech',                    // الافتراضي
        buildingScope: opts.scope || [],
        isActive: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
      if(!snap.exists) await ref.set(base);
      else await ref.set({updatedAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
    }

    function gotoByRole(role){
      if(role==='admin') location.href='Admin.html';
      else if(role==='ops') location.href='ops.htm';
      else location.href='Tech.html';
    }

    btnLogin.onclick = async ()=>{
      liMsg.textContent='';
      try{
        const cred = await auth.signInWithEmailAndPassword(liEmail.value.trim(), liPassword.value);
        await ensureUserDoc(cred.user);
        const udoc = await db.collection('users').doc(cred.user.uid).get();
        gotoByRole(udoc.data()?.role||'tech');
      }catch(err){ liMsg.textContent = 'خطأ: '+(err.message||err.code); }
    };

    btnSignup.onclick = async ()=>{
      suMsg.textContent='';
      const scope=[]; if(sC2.checked) scope.push('C2'); if(sC4.checked) scope.push('C4'); if(sC6.checked) scope.push('C6');
      try{
        const cred = await auth.createUserWithEmailAndPassword(suEmail.value.trim(), suPassword.value);
        await cred.user.updateProfile({displayName: suName.value.trim()});
        await ensureUserDoc(cred.user, {name: suName.value.trim(), scope});
        gotoByRole('tech');
      }catch(err){ suMsg.textContent = 'خطأ: '+(err.message||err.code); }
    };

    btnRst.onclick = async ()=>{
      try{ await auth.sendPasswordResetEmail(liEmail.value.trim()); liMsg.textContent='تم إرسال رابط الاسترجاع'; }
      catch(err){ liMsg.textContent='خطأ: '+(err.message||err.code); }
    };
  </script>
</body>
</html>
