<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة الفني – Emperor Hills Alpha</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{ font-family:'Cairo',system-ui; background:#0f172a0a; }
    .kpi{ border-radius:16px; padding:14px; background:#fff; box-shadow:0 6px 16px #00000012 }
    .ticket-card{ border-radius:14px; overflow:hidden; box-shadow:0 6px 16px #00000010 }
    .badge-dot{ width:10px; height:10px; border-radius:999px; display:inline-block }
    .state-new{ background:#e5e7eb }
    .state-assigned{ background:#3b82f6 }
    .state-progress{ background:#f59e0b }
    .state-hold{ background:#8b5cf6 }
    .state-done{ background:#16a34a }
    .state-overdue{ background:#ef4444 }
    .btn-pill{ border-radius:999px }
    .thumbnail{ width:68px; height:68px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb }
  </style>
</head>
<body>
  <nav class="navbar bg-white border-bottom shadow-sm">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <span class="fw-bold">لوحة الفني • Emperor Hills Alpha</span>
        <select id="buildingFilter" class="form-select form-select-sm" style="width:120px">
          <option value="all">كل البنايات</option>
          <option value="C2">C2</option>
          <option value="C4">C4</option>
          <option value="C6">C6</option>
        </select>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input id="techName" class="form-control form-control-sm" placeholder="اسم الفني" style="width:180px"/>
        <button id="btnSetTech" class="btn btn-primary btn-sm btn-pill">تعيين</button>
        <span id="whoami" class="text-muted small"></span>
      </div>
    </div>
  </nav>

  <main class="container py-3">

    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3"><div class="kpi"><div class="text-muted small">مهامي اليوم</div><div id="kToday" class="fw-bold fs-4">0</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><div class="text-muted small">قيد التنفيذ</div><div id="kProgress" class="fw-bold fs-4">0</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><div class="text-muted small">مكتملة هذا الأسبوع</div><div id="kWeek" class="fw-bold fs-4">0</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><div class="text-muted small">متأخرة عن SLA</div><div id="kOverdue" class="fw-bold fs-4">0</div></div></div>
    </div>

    <ul class="nav nav-pills mb-3" id="tabs" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" id="tab-assigned" data-bs-toggle="pill" data-bs-target="#p-assigned" type="button" role="tab">المسندة إليّ</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" id="tab-available" data-bs-toggle="pill" data-bs-target="#p-available" type="button" role="tab">متاحة للالتقاط</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" id="tab-done" data-bs-toggle="pill" data-bs-target="#p-done" type="button" role="tab">مكتملة</button></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="p-assigned" role="tabpanel"><div id="listAssigned" class="row g-3"></div></div>
      <div class="tab-pane fade" id="p-available" role="tabpanel"><div id="listAvailable" class="row g-3"></div></div>
      <div class="tab-pane fade" id="p-done" role="tabpanel"><div id="listDone" class="row g-3"></div></div>
    </div>
  </main>

  <!-- Modal: Ticket Details / Actions -->
  <div class="modal fade" id="ticketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">تفاصيل التذكرة</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="tMeta" class="mb-3 small text-muted"></div>
          <p id="tDesc" class="mb-3"></p>
          <div id="tAttachments" class="d-flex gap-2 flex-wrap mb-3"></div>

          <div class="border rounded p-3 mb-2">
            <div class="mb-2 fw-bold">إجراءات</div>
            <div class="d-flex flex-wrap gap-2">
              <button id="btnPick" class="btn btn-outline-primary btn-sm">استلام المهمة</button>
              <button id="btnStart" class="btn btn-primary btn-sm">بدء العمل</button>
              <button id="btnHold" class="btn btn-warning btn-sm">إيقاف مؤقت</button>
              <button id="btnComplete" class="btn btn-success btn-sm">وضع مكتمل</button>
            </div>
          </div>

          <div class="border rounded p-3">
            <div class="mb-2 fw-bold">إغلاق / تقرير الإنجاز</div>
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">ملاحظات</label>
                <textarea id="cNotes" class="form-control" rows="3"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">قطع/مواد مستخدمة (اختياري)</label>
                <input id="cParts" class="form-control" placeholder="مثال: سلك 2م، فيوز 10A"/>
              </div>
              <div class="col-md-6">
                <label class="form-label">تكلفة تقديرية (اختياري)</label>
                <input id="cCost" type="number" class="form-control" placeholder="IQD"/>
              </div>
              <div class="col-12">
                <label class="form-label">صور قبل/بعد (اختياري)</label>
                <input id="cFiles" type="file" multiple accept="image/*,video/mp4" class="form-control"/>
                <div id="cPreviews" class="d-flex gap-2 flex-wrap mt-2"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">إغلاق</button>
          <button id="btnSaveCompletion" class="btn btn-success">حفظ كـ مكتمل</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

  <script>
    // ===== Firebase Init =====
    const firebaseConfig = {
      apiKey: "AIzaSyAP5RViS9WdyEo8EaBflHyFag_T9_NKT7w",
      authDomain: "empiror-hills-alpha.firebaseapp.com",
      projectId: "empiror-hills-alpha",
      storageBucket: "empiror-hills-alpha.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ===== State =====
    let currentTech = JSON.parse(localStorage.getItem('eh_tech')||'null');
    let currentTicket = null; // for modal actions

    // ===== UI =====
    const whoami = document.getElementById('whoami');
    const techName = document.getElementById('techName');
    const btnSetTech = document.getElementById('btnSetTech');
    const buildingFilter = document.getElementById('buildingFilter');

    const listAssigned = document.getElementById('listAssigned');
    const listAvailable = document.getElementById('listAvailable');
    const listDone = document.getElementById('listDone');

    const kToday = document.getElementById('kToday');
    const kProgress = document.getElementById('kProgress');
    const kWeek = document.getElementById('kWeek');
    const kOverdue = document.getElementById('kOverdue');

    const ticketModal = new bootstrap.Modal(document.getElementById('ticketModal'));
    const tMeta = document.getElementById('tMeta');
    const tDesc = document.getElementById('tDesc');
    const tAttachments = document.getElementById('tAttachments');
    const btnPick = document.getElementById('btnPick');
    const btnStart = document.getElementById('btnStart');
    const btnHold = document.getElementById('btnHold');
    const btnComplete = document.getElementById('btnComplete');
    const btnSaveCompletion = document.getElementById('btnSaveCompletion');
    const cNotes = document.getElementById('cNotes');
    const cParts = document.getElementById('cParts');
    const cCost = document.getElementById('cCost');
    const cFiles = document.getElementById('cFiles');
    const cPreviews = document.getElementById('cPreviews');

    // ===== Helpers =====
    const stateClass = (status) => {
      switch(status){
        case 'new': return 'state-new';
        case 'assigned': return 'state-assigned';
        case 'in_progress': return 'state-progress';
        case 'on_hold': return 'state-hold';
        case 'completed': return 'state-done';
        default: return 'state-new';
      }
    }

    const fmtDate = (ts)=> {
      try{ return new Date(ts?.toDate?.() || ts || Date.now()).toLocaleString('ar-IQ'); }catch(e){ return '' }
    }

    function ticketCard(t){
      const div = document.createElement('div');
      div.className = 'col-12 col-md-6 col-lg-4';
      div.innerHTML = `
        <div class="card ticket-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="badge ${t.priority==='P1'?'text-bg-danger':t.priority==='P2'?'text-bg-warning':'text-bg-secondary'}">${t.priority}</span>
              <span class="badge-dot ${stateClass(t.status)}"></span>
            </div>
            <h6 class="card-title mb-1">${t.code}</h6>
            <div class="text-muted small mb-2">${t.building} • طابق ${String(t.floor).padStart(2,'0')} • ${t.unitLabel}</div>
            <p class="card-text small">${(t.description||'').slice(0,140)}</p>
            <div class="d-flex justify-content-between align-items-center">
              <span class="small text-muted">${fmtDate(t.createdAt)}</span>
              <button class="btn btn-sm btn-outline-primary">فتح</button>
            </div>
          </div>
        </div>`;
      div.querySelector('button').addEventListener('click', ()=> openTicket(t.id||t.code));
      return div;
    }

    function setTech(name){
      if(!name) return alert('أدخل اسم الفني');
      currentTech = { uid: name.toLowerCase().replace(/\s+/g,'_'), name };
      localStorage.setItem('eh_tech', JSON.stringify(currentTech));
      whoami.textContent = `الفني: ${currentTech.name}`;
      refreshAll();
    }

    // ===== Data Loading =====
    async function loadTickets(){
      const b = buildingFilter.value;

      // Assigned to me
      let q1 = db.collection('tickets').where('assignedTo.uid','==', currentTech?.uid || '__none__');
      if(b !== 'all') q1 = q1.where('building','==', b);
      q1 = q1.orderBy('createdAt','desc').limit(30);
      const s1 = await q1.get();

      // Available (new & unassigned)
      let q2 = db.collection('tickets').where('status','in', ['new','assigned']);
      if(b !== 'all') q2 = q2.where('building','==', b);
      q2 = q2.orderBy('createdAt','desc').limit(30);
      const s2 = await q2.get();

      // Done (my completed)
      let q3 = db.collection('tickets').where('status','==','completed');
      if(b !== 'all') q3 = q3.where('building','==', b);
      q3 = q3.orderBy('updatedAt','desc').limit(30);
      const s3 = await q3.get();

      // Render
      listAssigned.innerHTML='';
      s1.forEach(d=> listAssigned.appendChild(ticketCard({id:d.id, ...d.data()})) );

      listAvailable.innerHTML='';
      s2.forEach(d=>{
        const t = {id:d.id, ...d.data()};
        if(!t.assignedTo || !t.assignedTo.uid){ // only free
          listAvailable.appendChild(ticketCard(t));
        }
      });

      listDone.innerHTML='';
      s3.forEach(d=> listDone.appendChild(ticketCard({id:d.id, ...d.data()})) );

      // KPIs
      kToday.textContent = s1.docs.filter(d=>{
        const dt = d.data().createdAt?.toDate?.() || d.data().createdAt || Date.now();
        const today = new Date(); today.setHours(0,0,0,0);
        return (new Date(dt) >= today);
      }).length;
      kProgress.textContent = s1.docs.filter(d=> d.data().status === 'in_progress').length;
      kWeek.textContent = s3.docs.filter(d=>{
        const dt = d.data().updatedAt?.toDate?.() || d.data().updatedAt || Date.now();
        const weekAgo = new Date(Date.now()-7*24*60*60*1000);
        return (new Date(dt) >= weekAgo);
      }).length;
      // Overdue (simple heuristic: P1 older than 4h, P2 older than 24h)
      kOverdue.textContent = s1.docs.filter(d=>{
        const t = d.data();
        const created = new Date(t.createdAt?.toDate?.() || t.createdAt || Date.now()).getTime();
        const ageH = (Date.now()-created)/3600000;
        if(t.priority==='P1' && ageH>4) return true;
        if(t.priority==='P2' && ageH>24) return true;
        return false;
      }).length;
    }

    async function openTicket(id){
      const doc = await db.collection('tickets').doc(id).get();
      if(!doc.exists) return alert('التذكرة غير موجودة');
      const t = {id:doc.id, ...doc.data()};
      currentTicket = t;

      tMeta.innerHTML = `<div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="badge-dot ${stateClass(t.status)}"></span>
        <span>${t.code}</span>
        <span class="text-muted">• ${t.building} • طابق ${String(t.floor).padStart(2,'0')} • ${t.unitLabel}</span>
        <span class="badge ${t.priority==='P1'?'text-bg-danger':t.priority==='P2'?'text-bg-warning':'text-bg-secondary'}">${t.priority}</span>
        <span class="text-muted">إنشاء: ${fmtDate(t.createdAt)}</span>
      </div>`;
      tDesc.textContent = t.description || '';
      tAttachments.innerHTML = '';
      (t.attachments||[]).forEach(a=>{
        const el = document.createElement(a.type?.startsWith('image/')?'img':'video');
        el.src = a.url; el.className='thumbnail'; if(el.tagName==='VIDEO') el.controls=true;
        tAttachments.appendChild(el);
      })

      // buttons visibility
      btnPick.style.display = (!t.assignedTo || !t.assignedTo.uid)? 'inline-block':'none';
      btnStart.style.display = (t.assignedTo?.uid===currentTech?.uid && t.status!=='in_progress')? 'inline-block':'none';
      btnHold.style.display = (t.assignedTo?.uid===currentTech?.uid && t.status==='in_progress')? 'inline-block':'none';
      btnComplete.style.display = (t.assignedTo?.uid===currentTech?.uid && (t.status==='in_progress' || t.status==='on_hold'))? 'inline-block':'none';

      // reset complete form
      cNotes.value=''; cParts.value=''; cCost.value=''; cFiles.value=''; cPreviews.innerHTML='';

      ticketModal.show();
    }

    // ===== File Previews =====
    cFiles?.addEventListener('change', ()=>{
      cPreviews.innerHTML='';
      Array.from(cFiles.files).forEach(file=>{
        const url = URL.createObjectURL(file);
        const el = document.createElement(file.type.startsWith('image/')? 'img':'video');
        el.src = url; el.className='thumbnail'; if(el.tagName==='VIDEO') el.controls=true; cPreviews.appendChild(el);
      })
    });

    // ===== Actions =====
    async function pickTicket(){
      if(!currentTech) return alert('حدد اسم الفني أولاً');
      const ref = db.collection('tickets').doc(currentTicket.id);
      await db.runTransaction(async (tx)=>{
        const snap = await tx.get(ref);
        const t = snap.data();
        if(t.assignedTo && t.assignedTo.uid) throw new Error('تم إسنادها مسبقًا');
        tx.update(ref, {
          assignedTo: { uid: currentTech.uid, name: currentTech.name },
          status: 'assigned',
          acceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
      });
      await openTicket(currentTicket.id);
      await refreshAll();
    }

    async function startWork(){
      const ref = db.collection('tickets').doc(currentTicket.id);
      await ref.update({
        status: 'in_progress',
        startedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        assignedTo: { uid: currentTech.uid, name: currentTech.name }
      });
      await openTicket(currentTicket.id);
      await refreshAll();
    }

    async function holdWork(){
      const ref = db.collection('tickets').doc(currentTicket.id);
      await ref.update({ status: 'on_hold', updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      await openTicket(currentTicket.id);
      await refreshAll();
    }

    async function uploadCompletionFiles(ticketId){
      const files = Array.from(cFiles.files||[]);
      const uploaded = [];
      for(const file of files){
        const ref = storage.ref(`attachments/${ticketId}/after_${Date.now()}_${file.name}`);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        uploaded.push({ name:file.name, url, type:file.type, size:file.size, tag:'after' });
      }
      return uploaded;
    }

    async function saveCompletion(){
      if(!currentTicket) return;
      const id = currentTicket.id;
      const after = await uploadCompletionFiles(id);
      const ref = db.collection('tickets').doc(id);
      await ref.update({
        status: 'completed',
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        completion: {
          by: { uid: currentTech.uid, name: currentTech.name },
          notes: cNotes.value||'',
          parts: cParts.value||'',
          cost: Number(cCost.value||0) || 0
        },
        attachments: firebase.firestore.FieldValue.arrayUnion(...after)
      });
      ticketModal.hide();
      await refreshAll();
      alert('تم حفظ التذكرة كمكتملة');
    }

    // ===== Wiring =====
    btnSetTech.addEventListener('click', ()=> setTech(techName.value.trim()));
    buildingFilter.addEventListener('change', refreshAll);
    document.getElementById('btnPick').addEventListener('click', pickTicket);
    document.getElementById('btnStart').addEventListener('click', startWork);
    document.getElementById('btnHold').addEventListener('click', holdWork);
    btnSaveCompletion.addEventListener('click', saveCompletion);
    document.getElementById('btnComplete').addEventListener('click', ()=>{
      // focus to completion section
      document.getElementById('ticketModal').querySelector('.modal-body').scrollTo({top: 10000, behavior:'smooth'});
    });

    async function refreshAll(){
      await loadTickets();
    }

    // ===== Boot =====
    (async function(){
      if(currentTech){ whoami.textContent = `الفني: ${currentTech.name}`; techName.value=currentTech.name; }
      await refreshAll();
    })();
  </script>
</body>
</html>
