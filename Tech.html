<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة الفني – Emperor Hills Alpha</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{ font-family:'Cairo',system-ui; background:#0f172a0a; }
    .card{ border-radius:16px; box-shadow:0 8px 24px #00000012 }
    .btn-pill{ border-radius:999px }
    .checkbox-tile{ border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#fff }
  </style>
</head>
<body>
  <nav class="navbar bg-white border-bottom shadow-sm">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <span class="fw-bold">لوحة الفني</span>
        <select id="building" class="form-select form-select-sm" style="width:120px">
          <option value="C2">C2</option><option value="C4">C4</option><option value="C6">C6</option>
        </select>
        <select id="floor" class="form-select form-select-sm" style="width:120px"></select>
        <select id="unit" class="form-select form-select-sm" style="width:140px"></select>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="who" class="text-muted small"></span>
        <button id="logout" class="btn btn-outline-secondary btn-sm btn-pill">خروج</button>
      </div>
    </div>
  </nav>

  <main class="container py-3">
    <div class="card p-3 mb-3">
      <h6 class="mb-2">قائمة فحص الوحدة</h6>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="checkbox-tile">
            <div class="fw-bold">1) نقطة أحادية ×5</div>
            <div class="d-flex flex-wrap gap-2 mt-2" id="singlePts"></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="checkbox-tile">
            <div class="fw-bold">2) نقطة ثنائية ×1</div>
            <div class="d-flex gap-2 mt-2" id="doublePts"></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="checkbox-tile">
            <div class="fw-bold">3) نقطة ثلاثية ×9</div>
            <div class="d-flex flex-wrap gap-2 mt-2" id="triplePts"></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="checkbox-tile">
            <div class="fw-bold">4) شاشة تحكم</div>
            <div class="form-check mt-2"><input id="ctlScreen" class="form-check-input" type="checkbox"> <label class="form-check-label" for="ctlScreen">تم التحقق</label></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="checkbox-tile">
            <div class="fw-bold">5) ريموت تحكم بالسبلت ×4</div>
            <div class="d-flex flex-wrap gap-2 mt-2" id="remotes"></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="checkbox-tile">
            <div class="fw-bold">6) قفل الباب 103</div>
            <div class="form-check mt-2"><input id="lock103" class="form-check-input" type="checkbox"> <label class="form-check-label" for="lock103">تم التحقق</label></div>
          </div>
        </div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button id="save" class="btn btn-success btn-pill">حفظ الحالة</button>
        <span id="msg" class="small text-muted"></span>
      </div>
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAP5RViS9WdyEo8EaBflHyFag_T9_NKT7w",
      authDomain: "empiror-hills-alpha.firebaseapp.com",
      projectId: "empiror-hills-alpha",
      storageBucket: "empiror-hills-alpha.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const building = document.getElementById('building');
    const floor = document.getElementById('floor');
    const unit = document.getElementById('unit');
    const who = document.getElementById('who');
    const msg = document.getElementById('msg');

    function fillFloors(){ floor.innerHTML=''; for(let f=1; f<=16; f++){ const o=document.createElement('option'); o.value=f; o.textContent='طابق '+String(f).padStart(2,'0'); floor.appendChild(o); } }
    function fillUnits(){ unit.innerHTML=''; ['A','B','C','D'].forEach(u=>{ const o=document.createElement('option'); o.value=u; o.textContent='شقة '+u; unit.appendChild(o); }); }
    fillFloors(); fillUnits();

    function mkChecks(holderId, n){
      const holder = document.getElementById(holderId);
      holder.innerHTML='';
      for(let i=0;i<n;i++){
        const id=holderId+'_'+i;
        holder.insertAdjacentHTML('beforeend', `<div class="form-check"><input class="form-check-input" id="${id}" type="checkbox"><label class="form-check-label" for="${id}">${i+1}</label></div>`);
      }
    }
    mkChecks('singlePts',5); mkChecks('doublePts',1); mkChecks('triplePts',9); mkChecks('remotes',4);

    function setChecks(prefix, arr){ for(let i=0;;i++){ const el=document.getElementById(prefix+'_'+i); if(!el) break; el.checked=!!arr[i]; } }
    function getChecks(prefix){ const arr=[]; for(let i=0;;i++){ const el=document.getElementById(prefix+'_'+i); if(!el) break; arr.push(!!el.checked); } return arr; }

    auth.onAuthStateChanged(async (u)=>{
      if(!u) return location.href='index.html';
      who.textContent = u.displayName||u.email;
      const snap = await db.collection('users').doc(u.uid).get();
      const scope = snap.data()?.buildingScope||[];
      if(scope.length) building.value = scope[0];
      await loadCurrent();
    });

    async function loadCurrent(){
      msg.textContent='';
      const id = `${building.value}_${floor.value}_${unit.value}`;
      const ref = db.collection('unitInspections').doc(id);
      const doc = await ref.get();
      const data = doc.data()||{};
      setChecks('singlePts', data.singlePts||[]);
      setCheck
