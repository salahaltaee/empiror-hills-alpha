<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة الفني</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{ font-family:'Cairo',system-ui; background:#0f172a0a; }
    .card{ border-radius:16px; box-shadow:0 8px 24px #00000012 }
    .unit-btn{ min-width:64px }
    .btn-pill{ border-radius:999px }
    .checkbox-tile{ border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#fff }
  </style>
</head>
<body>
  <nav class="navbar bg-white border-bottom shadow-sm">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <span class="fw-bold">لوحة الفني</span>
        <select id="building" class="form-select form-select-sm" style="width:120px"><option>C2</option><option>C4</option><option>C6</option></select>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="who" class="small text-muted"></span>
        <button id="logout" class="btn btn-outline-secondary btn-sm btn-pill">خروج</button>
      </div>
    </div>
  </nav>

  <main class="container py-3">

    <!-- شبكة الشقق -->
    <div class="card p-3 mb-3">
      <h6>اختر الشقة</h6>
      <div id="grid" class="row g-2"></div>
    </div>

    <!-- الفحص -->
    <div class="card p-3 mb-3" id="inspectCard" style="display:none">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="m-0">قائمة فحص: <span id="unitLabel"></span></h6>
        <button id="btnWA" class="btn btn-sm btn-success btn-pill">طلب مواد (واتساب)</button>
      </div>
      <hr>
      <div class="row g-3">
        <div class="col-md-6"><div class="checkbox-tile"><div class="fw-bold">1) نقطة أحادية ×5</div><div id="singlePts" class="d-flex flex-wrap gap-2 mt-2"></div></div></div>
        <div class="col-md-6"><div class="checkbox-tile"><div class="fw-bold">2) نقطة ثنائية ×1</div><div id="doublePts" class="d-flex gap-2 mt-2"></div></div></div>
        <div class="col-md-6"><div class="checkbox-tile"><div class="fw-bold">3) نقطة ثلاثية ×9</div><div id="triplePts" class="d-flex flex-wrap gap-2 mt-2"></div></div></div>
        <div class="col-md-6"><div class="checkbox-tile"><div class="fw-bold">4) شاشة تحكم</div><div class="form-check mt-2"><input id="ctlScreen" class="form-check-input" type="checkbox"><label class="form-check-label ms-2" for="ctlScreen">تم التحقق</label></div></div></div>
        <div class="col-md-6"><div class="checkbox-tile"><div class="fw-bold">5) ريموت تحكم بالسبلت ×4</div><div id="remotes" class="d-flex flex-wrap gap-2 mt-2"></div></div></div>
        <div class="col-md-6"><div class="checkbox-tile"><div class="fw-bold">6) قفل الباب 103</div><div class="form-check mt-2"><input id="lock103" class="form-check-input" type="checkbox"><label class="form-check-label ms-2" for="lock103">تم التحقق</label></div></div></div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button id="btnSave" class="btn btn-primary btn-pill">حفظ الحالة</button>
        <span id="iMsg" class="small text-muted"></span>
        <span class="ms-auto small">المتبقي في البناية: <b id="remain">0</b> شقة</span>
      </div>
    </div>

    <!-- الطلبات المعينة للفني -->
    <div class="card p-3">
      <h6>طلبات الصيانة المسندة إليّ</h6>
      <div id="tickets" class="row g-2"></div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script>
    const cfg={apiKey:"AIzaSyAP5RViS9WdyEo8EaBflHyFag_T9_NKT7w",authDomain:"empiror-hills-alpha.firebaseapp.com",projectId:"empiror-hills-alpha",storageBucket:"empiror-hills-alpha.appspot.com"};
    firebase.initializeApp(cfg);
    const auth=firebase.auth(); const db=firebase.firestore();

    const who=document.getElementById('who'); const building=document.getElementById('building'); const grid=document.getElementById('grid');
    const inspectCard=document.getElementById('inspectCard'); const unitLabel=document.getElementById('unitLabel'); const iMsg=document.getElementById('iMsg'); const remain=document.getElementById('remain');
    let cur={b:'C2', f:1, u:'A'};

    function unitId(b,f,u){ return `${b}_${f}_${u}`; }
    function mkChecks(holderId, n){ const h=document.getElementById(holderId); h.innerHTML=''; for(let i=0;i<n;i++){ const id=holderId+'_'+i; h.insertAdjacentHTML('beforeend', `<div class="form-check"><input class="form-check-input" id="${id}" type="checkbox"><label class="form-check-label" for="${id}">${i+1}</label></div>`); } }
    mkChecks('singlePts',5); mkChecks('doublePts',1); mkChecks('triplePts',9); mkChecks('remotes',4);
    function setChecks(prefix, arr){ for(let i=0;;i++){ const el=document.getElementById(prefix+'_'+i); if(!el) break; el.checked=!!arr[i]; } }
    function getChecks(prefix){ const a=[]; for(let i=0;;i++){ const el=document.getElementById(prefix+'_'+i); if(!el) break; a.push(!!el.checked);} return a; }

    function drawGrid(){
      grid.innerHTML='';
      for(let f=16; f>=1; f--){
        ['A','B','C','D'].forEach(u=>{
          const div=document.createElement('div'); div.className='col-3';
          div.innerHTML=`<button class="btn btn-outline-secondary w-100 unit-btn">${f}/${u}</button>`;
          const btn=div.querySelector('button');
          btn.onclick=()=> openUnit(f,u);
          grid.appendChild(div);
        });
      }
    }

    async function openUnit(f,u){
      cur={b:building.value, f, u};
      unitLabel.textContent = `${cur.b}/${cur.f}/${cur.u}`;
      inspectCard.style.display='';
      await loadInspection();
      await calcRemain();
    }

    async function loadInspection(){
      const id=unitId(cur.b,cur.f,cur.u);
      const doc=await db.collection('unitInspections').doc(id).get();
      const d=doc.data()||{};
      setChecks('singlePts', d.singlePts||[]);
      setChecks('doublePts', d.doublePts||[]);
      setChecks('triplePts', d.triplePts||[]);
      setChecks('remotes', d.remotes||[]);
      document.getElementById('ctlScreen').checked=!!d.ctlScreen;
      document.getElementById('lock103').checked=!!d.lock103;
      iMsg.textContent='';
    }

    function score(d){
      const s=(d.singlePts||[]).filter(Boolean).length+(d.doublePts||[]).filter(Boolean).length+(d.triplePts||[]).filter(Boolean).length+(d.remotes||[]).filter(Boolean).length+(d.ctlScreen?1:0)+(d.lock103?1:0);
      return s;
    }

    async function calcRemain(){
      const b=building.value; let remainCnt=0;
      for(let f=1;f<=16;f++){ for(const u of ['A','B','C','D']){
        const doc=await db.collection('unitInspections').doc(unitId(b,f,u)).get();
        const d=doc.data(); const max=5+1+9+4+1+1;
        if(!d || score(d)<max) remainCnt++;
      }} 
      remain.textContent = remainCnt;
    }

    document.getElementById('btnSave').onclick = async ()=>{
      const u=auth.currentUser; if(!u) return;
      const id=unitId(cur.b,cur.f,cur.u);
      await db.collection('unitInspections').doc(id).set({
        building:cur.b, floor:cur.f, unit:cur.u, unitLabel:`${cur.b}/${cur.f}/${cur.u}`,
        singlePts:getChecks('singlePts'), doublePts:getChecks('doublePts'), triplePts:getChecks('triplePts'),
        ctlScreen:ctlScreen.checked, remotes:getChecks('remotes'), lock103:lock103.checked,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        tech:{uid:u.uid, name:u.displayName||u.email}
      },{merge:true});
      iMsg.textContent='تم الحفظ';
      await calcRemain();
    };

    // واتساب طلب مواد
    document.getElementById('btnWA').onclick=()=>{
      const txt=`أحتاج مواد للوحدة ${cur.b}/${cur.f}/${cur.u}`;
      window.open('https://wa.me/9647771003004?text='+encodeURIComponent(txt),'_blank');
    };

    // تذاكر الصيانة المكلّفة لهذا الفني
    const ticketsDiv=document.getElementById('tickets');
    function tCard(t){
      const div=document.createElement('div'); div.className='col-12 col-md-6 col-lg-4';
      div.innerHTML=`<div class="card p-3 h-100">
        <div class="d-flex justify-content-between"><span class="badge ${t.priority==='P1'?'text-bg-danger':'text-bg-warning'}">${t.priority||'P2'}</span><small class="text-muted">${new Date(t.createdAt?.toDate?.()||t.createdAt||Date.now()).toLocaleString('ar-IQ')}</small></div>
        <div class="fw-bold">${t.building}/${t.floor}/${t.unit}</div>
        <div class="small mb-2">${t.description||''}</div>
        <div class="d-flex gap-2">
          ${t.status==='assigned'?'<button class="btn btn-sm btn-primary">قبول/بدء</button>':''}
          ${(t.status==='in_progress' || t.status==='assigned')?'<button class="btn btn-sm btn-success">إنجاز</button>':''}
        </div>
      </div>`;
      const btns=div.querySelectorAll('button');
      if(btns[0]) btns[0].onclick=async()=>{ await db.collection('tickets').doc(t.id).set({status:'in_progress', startedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); loadTickets(); };
      if(btns[1]) btns[1].onclick=async()=>{ await db.collection('tickets').doc(t.id).set({status:'completed', completedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); loadTickets(); };
      return div;
    }

    async function loadTickets(){
      ticketsDiv.innerHTML='';
      const u=auth.currentUser; if(!u) return;
      const s=await db.collection('tickets').where('assignedTo.uid','==',u.uid).where('status','in',['assigned','in_progress']).orderBy('createdAt','desc').get();
      s.forEach(d=> ticketsDiv.appendChild(tCard({id:d.id, ...d.data()})));
    }

    building.onchange=drawGrid;

    auth.onAuthStateChanged(async (u)=>{ if(!u) location.href='index.html'; who.textContent=u.displayName||u.email; drawGrid(); loadTickets(); });
    logout.onclick=()=> auth.signOut().then(()=> location.href='index.html');
  </script>
</body>
</html>
